:root{
  --bg:#ffffff; --fg:#111827; --muted:#6b7280; --accent:#2563eb; --panel:#f9fafb; --card:#ffffff; --border:#e5e7eb;
  --red:#d32f2f; --blue:#1976d2; --green:#2e7d32; --yellow:#b7791f; --orange:#ef6c00; --pink:#ad1457;
}
*{box-sizing:border-box}
html,body,#app{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
body{-webkit-tap-highlight-color: transparent}
button{background:var(--accent);color:#ffffff;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
button.secondary{background:transparent;color:var(--fg);border:1px solid var(--border)}
button.tool{display:block;width:100%;margin-bottom:6px}
input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg)}
select{width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg)}

.topbar{display:grid;grid-template-columns:1fr minmax(200px, 480px) 1fr;gap:12px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
.brand{font-weight:800;cursor:pointer;user-select:none}
.brand:focus{outline:2px solid var(--accent);outline-offset:2px;border-radius:6px}
.titlebar input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
.top-actions{display:flex;gap:8px;justify-content:flex-end;align-items:center}
.mobile-only{display:none}
.home #btn-toggle-sidebar, .home #btn-focus{display:none}
.home .titlebar{display:none}

.view{display:flex;gap:16px;padding:16px;max-width:1400px;margin:0 auto}
.hidden{display:none}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px;flex:1;min-width:280px}
.actions{margin-top:10px;display:flex;gap:10px}
.actions.stack{flex-direction:column}
.home-modes .big{font-size:18px;padding:14px 18px}
.home-modes .hint{margin-top:8px;color:var(--muted);font-size:13px}

.sidebar{width:320px;min-width:280px;display:flex;flex-direction:column;gap:12px}
.sidebar{overflow:auto}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
.panel.collapsible > h3{margin:0 0 8px 0; cursor:pointer; user-select:none}
.panel.collapsed > .panel-content{display:none}
.panel.collapsible > h3::after{content:'▾'; float:right; opacity:.6}
.panel.collapsed > h3::after{content:'▸'}
.panel .hint{font-size:12px;color:var(--muted);margin-top:8px}
.cards{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.card-item{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:14px;white-space:normal;word-break:break-word;max-width:100%}
.card-item .cat{opacity:.7;margin-left:4px}
.alea{margin-top:8px}
.draw-controls{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.proposal{border:1px dashed var(--border);border-radius:10px;padding:8px;margin-top:8px;max-width:100%}
.puzzle-details{margin-top:8px;padding:8px;border:1px dashed var(--border);border-radius:10px;background:var(--card);font-size:14px}
.puzzle-details{max-width:100%;font-size:13px}
.puzzle-details .cards{display:flex;flex-direction:column;gap:6px}
.puzzle-details.hidden{display:none}
.puzzle-details .title{font-weight:800}
.puzzle-details .meta{opacity:.8;margin-top:4px}
.puzzle-details ul{margin:6px 0; padding-left:18px}

.tools{display:grid;grid-template-columns:1fr;gap:6px}
.tool.active{outline:2px solid var(--accent);background:transparent;color:var(--fg)}
.grid{margin-top:8px}

/* Mode switch */
.mode-switch{display:flex;gap:8px}
.mode-btn{flex:1;background:#fff;color:#111;border:1px solid var(--border)}
.mode-btn.active{outline:2px solid var(--accent);background:transparent}
.mode-hint{font-size:12px;color:var(--muted);margin-top:6px}

/* Score / progression */
#score-panel .score-row{display:flex;justify-content:space-between;align-items:center}
.progress{height:10px;background:#e5e7eb;border-radius:6px;margin-top:8px;overflow:hidden}
#progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#10b981,#2563eb);transition:width .3s ease}

.board-wrap{flex:1;min-width:0;background:var(--card);border:1px solid var(--border);border-radius:12px;position:relative;overflow:hidden;min-height:calc(100vh - 120px)}
.board{position:absolute;inset:0}
.svg-board{touch-action:none}
/* Legend */
.legend{position:absolute;left:8px;bottom:8px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 8px;box-shadow:0 4px 14px rgba(0,0,0,.08);font-size:12px;color:#111;z-index:50}
.legend .leg-row{display:flex;align-items:center;gap:8px;margin:3px 0}
.legend .leg-line{display:inline-block;width:26px;height:0;border-bottom:3px dashed var(--blue)}
.legend .leg-line.energy{border-bottom:5px solid var(--red)}
.legend .leg-line.signal{border-bottom:3px dashed var(--blue)}
.legend .leg-line.control{border-bottom:3.5px dashed var(--green)}
.legend .leg-label{white-space:nowrap}

/* Board SVG */
.svg-board{width:100%;height:100%;background-image:linear-gradient(to right, rgba(0,0,0,.06) 1px, transparent 1px),linear-gradient(to bottom, rgba(0,0,0,.06) 1px, transparent 1px);background-size:20px 20px,20px 20px}
.block{cursor:grab}
.block:active{cursor:grabbing}
.block rect{fill:#ffffff;stroke:#9ca3af;stroke-width:2.5}
.block text{fill:#111827;font-weight:700;pointer-events:none}
.block .title{font-size:16px}
.block .category{font-size:12px;opacity:.85}
.block.selected rect{stroke:var(--accent)}
.link{stroke:var(--blue);stroke-width:2.5;marker-end:url(#arrow-blue);stroke-dasharray:6 4}
.link.energy{stroke:var(--red);stroke-width:4.5;marker-end:url(#arrow-red)}
.link.control{stroke:var(--green);stroke-width:3.5;marker-end:url(#arrow-green);stroke-dasharray:4 3}
.link.selected{filter:drop-shadow(0 0 2px rgba(16,185,129,.8))}
.label-bg{fill:rgba(17,24,39,.06);stroke:#9ca3af;stroke-width:1}
.label-text{fill:#111827;font-weight:700}
/* Handles au centre des arrêtes */
.block .handle{fill:#ffffff;stroke:#2563eb;stroke-width:2;opacity:0;transition:opacity .12s;pointer-events:auto;cursor:crosshair}
.block.hover .handle{opacity:1}
.block.selected .handle{opacity:1}

/* Link options (sidebar) */
#link-options.hidden{display:none}
#link-options h4{margin:8px 0 6px 0;font-size:13px;color:var(--muted)}
#link-options .actions{gap:6px}

/* Rectangle de sélection multi */
.rubberband{fill:rgba(37,99,235,.12);stroke:rgba(37,99,235,.6);stroke-width:1;stroke-dasharray:4 3}

/* Bulle de type de lien */
.link-bubble{position:fixed;transform:translate(-50%, -120%);background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px;display:flex;gap:6px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:3000}
.link-bubble button{padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:#fff;color:#111;font-weight:700}
.link-bubble .energy{color:#fff;background:var(--red);border-color:var(--red)}
.link-bubble .signal{color:#fff;background:var(--blue);border-color:var(--blue)}
.link-bubble .control{color:#fff;background:var(--green);border-color:var(--green)}
.link-bubble .danger{color:#fff;background:var(--red);border-color:var(--red)}

/* Éditeur inline pour titre de bloc */
.inline-editor{position:fixed;z-index:2500;padding:6px 8px;border:2px solid var(--accent);border-radius:8px;font-weight:700;font-size:16px;color:#111;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.15)}

/* Responsive */
@media (max-width: 900px){
  .view{flex-direction:column; padding:0}
  .mobile-only{display:inline-flex}
  .sidebar{width:100%}
  .board-wrap{height:calc(100svh - 56px); min-height:calc(100svh - 56px); border-radius:0; border-left:none; border-right:none}
}
@media (max-width: 600px){
  .topbar{grid-template-columns:1fr auto; grid-template-areas: 'brand actions' 'titlebar titlebar'}
  .brand{grid-area:brand}
  .titlebar{grid-area:titlebar}
  .top-actions{grid-area:actions}
  button{padding:12px 16px}
  input,select,textarea{padding:10px}
}

/* Hide sidebar on mobile when collapsed */
body.sidebar-collapsed .sidebar{display:none}
@media (max-width: 900px){
  body.sidebar-collapsed .board-wrap{height:calc(100svh - 56px)}
}

/* Floating toolbar (mobile) */
.mobile-toolbar{position:fixed;right:12px;bottom:12px;display:flex;gap:10px;z-index:2500}
.mobile-toolbar .fab{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);background:#fff;color:#111;font-weight:800;box-shadow:0 8px 22px rgba(0,0,0,.2)}
.mobile-toolbar .danger{background:var(--red);color:#fff;border-color:var(--red)}

/* Safer inline editor bounds */
.inline-editor{max-width:92vw}

/* Modal help */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:1000}
.modal .content{background:#fff;color:#111;max-width:760px;width:92%;border-radius:12px;border:1px solid #e5e7eb;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
.modal.hidden{display:none !important}
.modal h2{margin:0 0 6px 0}
.modal .close-row{display:flex;justify-content:flex-end}
.modal .close-row button{background:#fff;color:#111;border:1px solid #e5e7eb}
.focus-mode .topbar{display:none}
.focus-mode .view{padding:0}
.focus-mode .sidebar{display:none}
.focus-mode .board-wrap{height:100svh; min-height:100svh; border:none; border-radius:0}

/* Overlay panels in focus mode */
.overlay-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:2700}
.focus-mode.overlay-open .sidebar{display:block;position:fixed;top:0;right:0;bottom:0;width:min(420px,92vw);background:var(--panel);border-left:1px solid var(--border);z-index:2800;padding:12px;overflow:auto}
.focus-mode.overlay-open .sidebar .panel{background:var(--card)}

/* Mobile typography scaling */
@media (max-width: 600px){
  body{font-size:18px}
  .card-item{font-size:17px}
  .link-bubble button{font-size:16px}
  .inline-editor{font-size:20px}
}
